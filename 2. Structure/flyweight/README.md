# 享元/緩存 Flyweight/Cache
摒棄了在每個對像中保存所有數據的方式， 通過共享多個對象所共有的相同狀態， 讓你能在有限的內存容量中載入更多對象

## 優缺點
### 優點
1. 如果程序中有很多相似對象，那麼你將可以節省大量內存


### 缺點
* 可能需要犧牲執行速度來換取內存，因為他人每次調用享元方法時都需要重新計算部分情景數據
* 代碼會變得更加複雜

## Architecture

![](https://refactoringguru.cn/images/patterns/diagrams/flyweight/structure.png)

1. 享元模式只是一種優化

    * 在應用該模式之前，你要確定程序中存在與大量類似對象同時佔用內存相關的內存消耗問題，並且確保該問題無法使用其他更好的方式來解決

2. 享元(Flyweight)
    
    * 包含原始對像中部分能在多個對像中共享的狀態
    * 同一享元對象可在許多不同情景中使用
    * 享元中存儲的狀態被稱為"內在狀態"
    * 傳遞給享元方法的狀態被稱為 "外在狀態"

3. 情景(Context)
    
    * 包含原始對像中各不相同的外在狀態
    * 情景與享元對象組合在一起就能表示原始對象的全部狀態
 
4. 通常情況下， 原始對象的行為會保留在享元類中

    * 因此調用享元方法必須提供部分外在狀態作為參數
    * 但你也可將行為移動到情景類中，然後將連入的享元作為單純的數據對象
    
5. 客戶端(Client)

    * 負責計算或存儲享元的外在狀態
    * 在客戶端看來，享元是一種可在運行時進行配置的模闆對象，具體的配置方式為向其方法中傳入一些情景數據參數

6. 享元工廠(Flyweight Factory)
    
    * 會對已有享元的緩存池進行管理
    * 有了工廠後，客戶端就無需直接創建享元，它們只需調用工廠並向其傳遞目標享元的一些內在狀態即可
    * 工廠會根據參數在之前已創建的享元中進行查找，如果找到滿足條件的享元就將其返回
    * 如果沒有找到就根據參數新建享元


## 應用場景
* 僅在程序必須支持大量對象且沒有足夠的內存容量時

## 實現方式
下列五個步驟
1. 將需要改寫為享元的類成員變量拆分為兩個部分:

    * 內在狀態 
        * 包含不變的、 可在許多對像中重複使用的數據的成員變量
    * 外在狀態
        * 包含每個對象各自不同的情景數據的成員變量
    
2. 保留類中表示內在狀態的成員變量，並將其屬性設置為不可修改

    * 這些變量僅可在構造函數中獲得初始數值
    
3. 找到所有使用外在狀態成員變量的方法，為在方法中所用的每個成員變量新建一個參數，並使用該參數代替成員變量
    
4. 可以有選擇地創建工廠類來管理享元緩存池，它負責在新建享元時檢查已有的享元

    * 如果選擇使用工廠，客戶端就只能通過工廠來請求享元，它們需要將享元的內在狀態作為參數傳遞給工廠
    
5. 客戶端必須存儲和計算外在狀態（情景）的數值，因為只有這樣才能調用享元對象的方法

    * 為了使用方便，外在狀態和引用享元的成員變量可以移動到單獨的情景類中